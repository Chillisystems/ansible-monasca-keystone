import keystoneclient
from keystoneclient.v2_0 import client

def add_service_endpoint(key, service_name, endpoint_host):
  """Add the Monasca service to the catalog with the specified endpoint, if it doesn't yet exist."""
  service_names = { service.name: service.id for service in key.services.list() }
  if service_name in service_names.keys():
    service_id = service_names[service_name] 
  else:
    service=key.services.create(name=service_name, service_type='monitoring', description='Monasca monitoring service')
    service_id = service.id
 
  for endpoint in key.endpoints.list():
    if endpoint.service_id == service_id:
      return

  key.endpoints.create(region="RegionOne", service_id=service_id,
                            publicurl="http://%s:8080/v2.0/" % endpoint_host,
                            adminurl="http://%s:8080/v2.0/" % endpoint_host,
                            internalurl="http://%s:8080/v2.0/" % endpoint_host)

key = client.Client(token='{{ keystone_admin_token }}', endpoint='http://127.0.0.1:35357/v2.0/')
add_service_endpoint(key, '{{ keystone_endpoint.name }}', '{{ keystone_endpoint.host }}')

