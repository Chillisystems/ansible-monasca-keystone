from __future__ import print_function
from keystoneclient.v2_0 import client
import sys


def get_token(url, cacert):
{% if keystone_admin_username is defined %}
  username = '{{ keystone_admin_username }}'
{% else %}
  username = None
{% endif %}
{% if keystone_admin_password is defined %}
  password = '{{ keystone_admin_password }}'
{% else %}
  password = None
{% endif %}
{% if keystone_admin_tenant_name is defined %}
  tenant_name = '{{ keystone_admin_tenant_name }}'
{% else %}
  tenant_name = None
{% endif %}

  if not username or not password:
    print('If token is not given, keystone_admin_username and keystone_admin_password must be given', file=sys.stderr)
    return False

  if not tenant_name:
    print('If token is not given, keystone_admin_tenant_name must be given', file=sys.stderr)
    return False

  kwargs = {
      'username': username,
      'password': password,
      'tenant_name': tenant_name,
      'auth_url': url,
      'cacert': cacert
  }

  key = client.Client(**kwargs)
  token = key.auth_token
  return token


def get_tenant(key, tenant_name):
  """Get the tenant by name"""
  for tenant in key.tenants.list():
    if tenant.name == tenant_name:
      return tenant

  return None


def add_tenants(key, tenant_names):
  """Add the given tenant_names if they don't already exist"""
  for tenant_name in tenant_names:
    if not get_tenant(key, tenant_name):
      key.tenants.create(tenant_name=tenant_name, enabled=True)

  return True


def get_user(key, user_name):
  for user in key.users.list():
   if user.name == user_name:
     return user
  return None


def get_role(key, role_name):
  for role in key.roles.list():
   if role.name == role_name:
     return role
  return None


def add_users(key, users):
  """Add the given users if they don't already exist"""
  for user_name, attributes in users.iteritems():
    if not get_user(key, user_name):
      tenant_name = attributes['project']
      tenant = get_tenant(key, tenant_name)

      password = attributes['password']
      if 'email' in attributes:
        email = attributes['email']
      else:
        email = None

      user = key.users.create(name=user_name, password=password,
                              email=email, tenant_id=tenant.id)
  return True


def add_user_roles(key, users):
  """Add the roles for the users if they don't already have them"""
  for user_name, attributes in users.iteritems():
    if not 'role' in attributes:
      continue;
    role_name = attributes['role']
    user = get_user(key, user_name)
    tenant = get_tenant(key, attributes['project'])
    existing = None
    for role in key.roles.roles_for_user(user, tenant):
      if role.name == role_name:
         existing = role
         break
    if existing:
      continue

    role = get_role(key, role_name)
    if not role:
      role = key.roles.create(role_name)

    key.roles.add_user_role(user, role, tenant)
  return True

def add_service_endpoint(key, name, description, type, url):
  """Add the Monasca service to the catalog with the specified endpoint, if it doesn't yet exist."""
  service_names = { service.name: service.id for service in key.services.list() }
  if name in service_names.keys():
    service_id = service_names[name]
  else:
    service=key.services.create(name=name, service_type=type, description=description)
    service_id = service.id

  for endpoint in key.endpoints.list():
    if endpoint.service_id == service_id:
      if endpoint.publicurl == url and endpoint.adminurl == url and endpoint.internalurl == url:
        return True
      else:
        key.endpoints.delete(endpoint.id)

  key.endpoints.create(region="RegionOne", service_id=service_id, publicurl=url, adminurl=url, internalurl=url)
  return True


def add_monasca_service():
  return True


def main():
  """ Get token if needed and then call methods to add tenants, users and roles """
  users = {
{% for username, attributes in keystone_users.iteritems() %}
           '{{ username }}':
                            {{ attributes }},
{% endfor %}
           }

  url = '{{ keystone_url_v2 }}'

{% if keystone_admin_token is defined %}
  token = '{{ keystone_admin_token }}'
{% else %}
  token = None
{% endif %}

{% if keystone_local_cacert is defined %}
  cacert = '{{ keystone_local_cacert }}'
{% else %}
  cacert = None
{% endif %}
  if not token:
    token = get_token(url, cacert)

  key = client.Client(token=token, endpoint=url, cacert=cacert)

  tenants = []
  for user, attributes in users.iteritems():
    if 'project' in attributes and attributes['project'] not in tenants:
       tenants.append(attributes['project'])

  if not add_tenants(key, tenants):
    return 1

  if not add_users(key, users):
    return 1

  if not add_user_roles(key, users):
    return 1

  if add_service_endpoint(key, 'monasca', 'Monasca monitoring service', 'monitoring', '{{ monasca_api_url }}'):
    return 0
  else:
    return 1


if __name__ == "__main__":
    sys.exit(main())
